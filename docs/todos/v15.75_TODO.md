Here is the checklist for **Phase 8: The Wizard UI & Integration**.

This phase focuses on building the frontend interface that utilizes the backend services from Phase 7. We are moving from a "Chat-based Setup" to a "Form-based Extraction" workflow.

---

### **Step 1: Session Manager Updates (The Entry Point)**
**Goal:** Allow the creation of a session *with pre-populated data*, bypassing the old setup loop.

- [x] **1.1. Update `SessionManager.new_game`**
    *   **File:** `app/gui/managers/session_manager.py`
    *   **Change:** Instead of creating the session immediately, it should just open the `SetupWizard`.
    *   **Logic:**
        ```python
        def new_game(self, selected_prompt: Prompt):
            if not selected_prompt: return
            # Open Wizard, passing self and the prompt
            from app.gui.panels.setup_wizard import SetupWizard
            wizard = SetupWizard(self.orchestrator.view, self.db_manager, self.orchestrator, selected_prompt)
            self.orchestrator.view.wait_window(wizard)
        ```

- [x] **1.2. Implement `create_session_from_wizard`**
    *   **File:** `app/gui/managers/session_manager.py`
    *   **Purpose:** The method the Wizard calls when the user clicks "Start Game".
    *   **Logic:**
        1.  Create `GameSession` row (DB).
        2.  Inject Ruleset/Template (Scaffolding).
        3.  **Overwrite** Player Entity with extracted data (Stats, Inventory, Companions).
        4.  **Create** Location Entity and set `active_scene`.
        5.  **Create** Lore Memories.
        6.  **Inject** the generated "Opening Crawl" as the first Assistant message.
        7.  Set `game_mode="GAMEPLAY"`.

---

### **Step 2: Wizard Architecture (The Container)**
**Goal:** A multi-step modal dialog that manages the state of the extraction data.

- [x] **2.1. Rewrite `app/gui/panels/setup_wizard.py`**
    *   **State Management:** Needs to hold the raw text inputs AND the extracted JSON objects in memory.
    *   **Navigation:** Implement a `step` pointer (0=Input, 1=Processing, 2=Review).
    *   **Layout:** Use `grid_remove()` / `grid()` to swap content frames without closing the window.

---

### **Step 3: Step 1 - The Concept (Input View)**
**Goal:** Capture the user's creative intent.

- [x] **3.1. Implement Split-Screen UI**
    *   **Left:** "World & Setting" `CTkTextbox`.
    *   **Right:** "Protagonist" `CTkTextbox`.
    *   **Header:** Display the name of the selected Prompt (e.g., "System: D&D 5e") so the user knows what rules to write for.

- [x] **3.2. Add "Randomize" Buttons (Stubs)**
    *   **Logic:** For now, populate with a random static preset based on the genre (e.g., a Sci-Fi preset, a Fantasy preset).
    *   *Future:* Call a creative LLM prompt to generate a random scenario.

---

### **Step 4: Step 2 - The Extraction (Processing View)**
**Goal:** Run the `WorldGenService` without freezing the GUI.

- [x] **4.1. Implement Threading**
    *   **Action:** Create a method `_run_extraction_thread`.
    *   **Logic:**
        1.  Show progress bar / spinner.
        2.  Call `WorldGenService.extract_character(...)`.
        3.  Call `WorldGenService.extract_world(...)`.
        4.  Call `WorldGenService.generate_opening(...)`.
        5.  Store results in `self.extraction_data`.
        6.  Use `.after(0, ...)` to trigger the transition to Step 3 on the main thread.

---

### **Step 5: Step 3 - The Review (Edit View)**
**Goal:** Allow the user to fix AI mistakes before the game starts.

- [x] **5.1. Tabbed Interface**
    *   **Tab 1: Character:**
        *   Display Name, Bio (Editable).
        *   **Stats Editor:** Since stats vary by system (STR vs. Agility), use a dynamic list of `CTkEntry` widgets based on the `suggested_stats` dictionary returned by the extraction.
        *   **Inventory:** Simple multi-line textbox (one item per line) is easiest for editing lists.
    *   **Tab 2: World:**
        *   Location Name & Description (Editable).
        *   Lore List (Editable).
    *   **Tab 3: Opening:**
        *   Large Textbox showing the generated "Opening Crawl". User can rewrite it if they don't like the tone.

---

### **Step 6: Step 4 - Initialization (Commit)**
**Goal:** Finalize the setup.

- [x] **6.1. Wire "Start Game" Button**
    *   **Action:** Collect all data from the Review tabs (in case user edited them).
    *   **Call:** `self.session_manager.create_session_from_wizard(...)`.
    *   **Close:** Destroy the wizard window.

---

### **Step 7: Visual Polish (Optional but Recommended)**

- [x] **7.1. Context Hinting**
    *   **Feature:** In Step 1, show a small "System Hint" label.
    *   **Logic:** Read `prompt.template_manifest` -> `ruleset`.
    *   **Display:** "Rules: D&D 5e. Valid Stats: STR, DEX, CON..." (Helps the user write better descriptions).

- [x] **7.2. Loading Messages**
    *   **Feature:** Update the loading label during extraction.
    *   **Sequence:** "Reading Ruleset..." -> "Analyzing Character..." -> "Building World..." -> "Writing Opening Scene...".
